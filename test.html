<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PortOne SDK -->
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  
  <script>
    var IMP = window.IMP; // Import 라이브러리 초기화
    IMP.init("imp03664607"); // 'imp03664607' 대신에 실제 사용하는 아임포트 가맹점 식별코드를 입력해야 합니다.

    function requestPay() {
        const merchantUid = "merchant_" + new Date().getTime(); // 고유 주문번호 생성

        IMP.request_pay({
            pg: "nice_v2",
            pay_method: "kakaopay",
            merchant_uid: merchantUid,
            name: "제발 되라",
            amount: 100,
            buyer_email: "Iamport@chai.finance",
            buyer_name: "포트원 기술지원팀",
            buyer_tel: "010-1234-5678",
            buyer_addr: "서울특별시 강남구 삼성동",
            buyer_postcode: "123-456",
        }, async (rsp) => {
            if (rsp.success) {
                try {
                    const response = await axios.post('/payments/verify', {
                        imp_uid: rsp.imp_uid,
                        merchant_uid: merchantUid,
                    });
                    if(response.status === 200) {
                        alert("결제가 성공적으로 완료되었습니다.");
                    } else {
                        alert("결제 검증에 실패했습니다.");
                    }
                } catch (error) {
                    console.error("결제 검증 요청 실패:", error);
                    alert("결제 검증 과정에서 오류가 발생했습니다.");
                }
            } else {
                alert(`결제에 실패하였습니다. 돈은 빠져 나감 에러 내용: ${rsp.error_msg}`);
            }
        });
    }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Features</title>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        var socket = io();

        socket.on('jwt', function(token) {
          sessionStorage.setItem('jwt', token);
        });

        function sendMessage() {
          var message = document.getElementById('message').value.trim();
          if (message === '') {
            return;
          }
          socket.emit('chat message', message);
          document.getElementById('message').value = '';
        }

        document.getElementById('sendButton').addEventListener('click', sendMessage);

        document.querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();

            var formData = new FormData(this);
            fetch('/user', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    document.getElementById('resultText').textContent = data.data;
                    document.getElementById('recognitionResult').style.display = 'block';
                } else {
                    document.getElementById('resultText').textContent = 'Error processing file.';
                    document.getElementById('recognitionResult').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultText').textContent = 'Error submitting the form.';
                document.getElementById('recognitionResult').style.display = 'block';
            });
        });

        socket.on('chat message', function(msg) {
          var item = document.createElement('li');
          item.textContent = msg;
          document.getElementById('messages').appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        });
      });
    </script>
  
    
</head>
<body>
<form action="/user" enctype="multipart/form-data" method="post">
  <div>
    <input type="file" name="uploaded_file" id="uploaded_file">
    <input type="text" placeholder="Number of speakers" name="nspeakers" id="nspeakers">
    <button type="submit">Upload and Analyze</button>
  </div>
</form>

<ul id="messages"></ul>
<input id="message" autocomplete="off"><button id="sendButton">Send</button>

<div id="recognitionResult" style="margin-top: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; display: none;">
    <span id="resultText">No results yet.</span>
</div>

<button onclick="requestPay()">결제하기</button>
    <!-- 결제하기 버튼 생성 -->

</body>
</html>
