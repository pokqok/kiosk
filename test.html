<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Features</title>
    <!-- External Libraries -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<!-- File Upload Form -->
<form action="/user" enctype="multipart/form-data" method="post">
    <div>
        <input type="file" name="uploaded_file" id="uploaded_file">
        <input type="text" placeholder="Number of speakers" name="nspeakers" id="nspeakers">
        <button type="submit">Upload and Analyze</button>
    </div>
</form>

<!-- Messages List -->
<ul id="messages"></ul>
<!-- Message Input and Send Button -->
<input id="message" autocomplete="off">
<button id="sendButton">Send</button>

<!-- Recognition Result Display -->
<div id="recognitionResult" style="margin-top: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; display: none;">
    <span id="resultText">No results yet.</span>
</div>

<!-- Payment Button -->
<button onclick="requestPay()">결제하기</button>

<script>
    var IMP = window.IMP; 
    IMP.init("imp03664607"); 

    function requestPay() {
        const merchantUid = "merchant_" + new Date().getTime(); // Generate unique order number
        
        IMP.request_pay({
            pg: "html5_inicis.INIpayTest",
           // pay_method: "kakaopay", 카카오페이만을 결제 수단으로 한다면 추가. 여러가지 존재 가능
            merchant_uid: merchantUid,
            name: "제발 되라",
            amount: 100,
            buyer_email: "Iamport@chai.finance",
            buyer_name: "포트원 기술지원팀",
            buyer_tel: "010-1234-5678",
            buyer_addr: "서울특별시 강남구 삼성동",
            buyer_postcode: "123-456",
        }, rsp => {
            if (rsp.success) {
                console.log("성공");
                axios({
                    url: "http://192.168.56.1:3000/payments/verify", // ipconfig 이후 본인의 ipv4주소로 변경
                    method: "post",
                    headers: { "Content-Type": "application/json" },
                    data: {
                        imp_uid: rsp.imp_uid,
                        merchant_uid: rsp.merchant_uid
                    }
                }).then((data) => {
                    console.log("성공");
                    alert("결제가 완료되었습니다.");
                })
            } else {
                alert(`결제에 실패하였습니다. 에러 내용: ${rsp.error_msg}`);
            }
        });
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var socket = io();

        socket.on('jwt', function(token) {
            sessionStorage.setItem('jwt', token);
        });

        function sendMessage() {
            var message = document.getElementById('message').value.trim();
            if (message === '') return;
            
            socket.emit('chat message', message);
            document.getElementById('message').value = '';
        }

        document.getElementById('sendButton').addEventListener('click', sendMessage);

        document.querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            fetch('/user', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('resultText').textContent = data.success ? data.data : 'Error processing file.';
                document.getElementById('recognitionResult').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultText').textContent = 'Error submitting the form.';
                document.getElementById('recognitionResult').style.display = 'block';
            });
        });

        socket.on('chat message', function(msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            document.getElementById('messages').appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
    });
</script>

</body>
</html>
